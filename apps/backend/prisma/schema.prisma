generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// =====================================================
// Bảng admin_users - Quản lý tài khoản admin
// =====================================================
model User {
  id           Int        @id @default(autoincrement())
  username     String     @unique @db.VarChar(100)
  passwordHash String     @map("password_hash") @db.Text
  displayName  String     @map("display_name") @db.VarChar(255)
  avatar       String?    @db.Text
  role         String     @default("admin") @db.VarChar(50)
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")
  blogPosts    BlogPost[] @relation("BlogAuthor")
  
  // Edit requests made by this user
  editRequestsMade BlogEditRequest[] @relation("EditRequestsMade")

  @@map("admin_users")
}

// =====================================================
// Bảng blog_posts - Quản lý bài viết blog
// =====================================================
model BlogPost {
  id           Int       @id @default(autoincrement())
  code         String    @unique @db.VarChar(100)
  slug         String    @unique @db.VarChar(150)
  title        String    @db.Text
  subtitle     String?   @db.Text
  excerpt      String?   @db.Text
  content      String    @db.LongText
  imageUrl     String?   @map("image_url") @db.Text
  category     String?   @db.VarChar(120)
  tags         String?   @db.Text
  keywords     String?   @db.Text
  authorName   String?   @map("author_name") @db.VarChar(120)
  authorRole   String?   @map("author_role") @db.VarChar(120)
  authorAvatar String?   @map("author_avatar") @db.Text
  publishedAt  DateTime  @default(now()) @map("published_at")
  status       String    @default("published") @db.VarChar(40)
  galleryMedia Json?     @map("gallery_media")
  videoItems   Json?     @map("video_items")
  sourceLinks  Json?     @map("source_links")
  isFeatured   Int       @default(0) @map("is_featured") @db.TinyInt
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  
  // Relation với User (optional - nếu muốn liên kết author)
  authorId     Int?      @map("author_id")
  author       User?     @relation("BlogAuthor", fields: [authorId], references: [id])
  
  // Pending edit requests for this blog post
  editRequests BlogEditRequest[] @relation("BlogEditRequests")

  @@index([publishedAt(sort: Desc)], map: "idx_published_at")
  @@index([status], map: "idx_status")
  @@index([category], map: "idx_category")
  @@index([isFeatured], map: "idx_is_featured")
  @@map("blog_posts")
}

// =====================================================
// Bảng blog_edit_requests - Yêu cầu duyệt sửa bài viết
// =====================================================
model BlogEditRequest {
  id            Int       @id @default(autoincrement())
  blogPostId    Int       @map("blog_post_id")
  blogPost      BlogPost  @relation("BlogEditRequests", fields: [blogPostId], references: [id], onDelete: Cascade)
  
  // Người yêu cầu sửa
  requesterId   Int       @map("requester_id")
  requester     User      @relation("EditRequestsMade", fields: [requesterId], references: [id])
  
  // Nội dung đề xuất (JSON chứa toàn bộ thay đổi)
  proposedData  Json      @map("proposed_data")
  
  // Trạng thái: pending, approved, rejected
  status        String    @default("pending") @db.VarChar(20)
  
  // Ghi chú của người duyệt
  reviewNote    String?   @map("review_note") @db.Text
  
  // Thông tin thời gian
  createdAt     DateTime  @default(now()) @map("created_at")
  reviewedAt    DateTime? @map("reviewed_at")

  @@index([blogPostId], map: "idx_edit_request_blog")
  @@index([requesterId], map: "idx_edit_request_requester")
  @@index([status], map: "idx_edit_request_status")
  @@map("blog_edit_requests")
}

// =====================================================
// Bảng products - Quản lý sản phẩm
// =====================================================
model Product {
  id                Int      @id @default(autoincrement())
  code              String   @unique @db.VarChar(100)
  slug              String   @unique @db.VarChar(150)
  name              String   @db.Text
  category          String?  @db.VarChar(120)
  shortDescription  String?  @map("short_description") @db.Text
  description       String?  @db.LongText
  imageUrl          String?  @map("image_url") @db.Text
  featureTags       String?  @map("feature_tags") @db.Text
  highlights        String?  @db.Text
  ctaPrimaryLabel   String?  @map("cta_primary_label") @db.Text
  ctaPrimaryUrl     String?  @map("cta_primary_url") @db.Text
  ctaSecondaryLabel String?  @map("cta_secondary_label") @db.Text
  ctaSecondaryUrl   String?  @map("cta_secondary_url") @db.Text
  galleryMedia      Json?    @map("gallery_media")
  videoItems        Json?    @map("video_items")
  demoMedia         Json?    @map("demo_media")
  status            String   @default("active") @db.VarChar(40)
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  @@index([status], map: "idx_product_status")
  @@index([category], map: "idx_product_category")
  @@map("products")
}

// =====================================================
// Bảng customer_reviews - Đánh giá từ khách hàng
// =====================================================
model CustomerReview {
  id          Int      @id @default(autoincrement())
  name        String   @db.VarChar(255) @map("name")
  role        String   @db.VarChar(255) @map("role")
  company     String?  @db.VarChar(255) @map("company")
  rating      Float    @default(5) @db.Float
  quote       String   @db.Text
  bgColor     String   @default("#3B82F6") @map("bg_color") @db.VarChar(20)
  status      String   @default("published") @db.VarChar(40)
  isFeatured  Int      @default(0) @map("is_featured") @db.TinyInt
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([status], map: "idx_review_status")
  @@index([isFeatured], map: "idx_review_featured")
  @@index([createdAt(sort: Desc)], map: "idx_review_created")
  @@map("customer_reviews")
}

// =====================================================
// Bảng visit_stats - Thống kê lượt truy cập theo IP
// =====================================================
model VisitStat {
  id            Int      @id @default(autoincrement())
  ipAddress     String   @db.VarChar(45) @map("ip_address")
  userAgent     String?  @db.VarChar(255) @map("user_agent")
  visitCount    Int      @default(1) @map("visit_count")
  lastVisitedAt DateTime @map("last_visited_at")
  createdAt     DateTime @default(now()) @map("created_at")

  @@unique([ipAddress], map: "ux_visit_ip")
  @@index([ipAddress], map: "idx_visit_ip")
  @@index([lastVisitedAt(sort: Desc)], map: "idx_visit_last")
  @@map("visit_stats")
}

// =====================================================
// Bảng cookie_consents - Lưu chấp thuận cookie
// =====================================================
model CookieConsent {
  id            Int      @id @default(autoincrement())
  ipAddress     String   @db.VarChar(45) @map("ip_address")
  userAgent     String?  @db.VarChar(255) @map("user_agent")
  consented     Boolean  @default(true) @map("consented")
  preferences   Json?    @map("preferences")
  consentedAt   DateTime @default(now()) @map("consented_at")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@index([ipAddress], map: "idx_cookie_ip")
  @@index([consentedAt(sort: Desc)], map: "idx_cookie_time")
  @@map("cookie_consents")
}

// =====================================================
// Bảng sessions - Lưu trữ session đăng nhập
// =====================================================
model Session {
  sessionId String @id @map("session_id") @db.VarChar(128)
  expires   Int    @db.UnsignedInt
  data      String? @db.MediumText

  @@index([expires], map: "idx_expires")
  @@map("sessions")
}

// =====================================================
// Bảng system_logs - Nhật ký hoạt động hệ thống
// =====================================================
model SystemLog {
  id            Int       @id @default(autoincrement())
  action        String    @db.VarChar(100)                // CREATE, UPDATE, DELETE, VIEW, LOGIN, LOGOUT, etc.
  resource      String    @db.VarChar(100)                // blog, product, user, auth, etc.
  resourceId    String?   @map("resource_id") @db.VarChar(50) // ID của resource bị tác động
  description   String?   @db.Text                        // Mô tả chi tiết
  ipAddress     String    @map("ip_address") @db.VarChar(45)
  userAgent     String?   @map("user_agent") @db.VarChar(500)
  userId        Int?      @map("user_id")                 // Admin thực hiện (null nếu là guest)
  username      String?   @db.VarChar(100)                // Lưu username tại thời điểm log
  method        String?   @db.VarChar(10)                 // HTTP method
  path          String?   @db.VarChar(500)                // Request path
  statusCode    Int?      @map("status_code")             // HTTP status code
  duration      Int?      @db.Int                         // Request duration in ms
  requestBody   Json?     @map("request_body")            // Request body (sanitized)
  responseSize  Int?      @map("response_size")           // Response size in bytes
  createdAt     DateTime  @default(now()) @map("created_at")

  @@index([ipAddress], map: "idx_syslog_ip")
  @@index([userId], map: "idx_syslog_user")
  @@index([action], map: "idx_syslog_action")
  @@index([resource], map: "idx_syslog_resource")
  @@index([createdAt(sort: Desc)], map: "idx_syslog_time")
  @@map("system_logs")
}

// =====================================================
// Bảng blocked_ips - Quản lý IP bị chặn
// =====================================================
model BlockedIP {
  id            Int       @id @default(autoincrement())
  ipAddress     String    @unique @map("ip_address") @db.VarChar(45)
  reason        String    @db.VarChar(255)                // spam, ddos, scraping, manual
  threatScore   Float     @default(0) @map("threat_score") @db.Float  // 0-100%
  requestCount  Int       @default(0) @map("request_count")
  blockedAt     DateTime  @default(now()) @map("blocked_at")
  blockedBy     Int?      @map("blocked_by")              // Admin ID who blocked
  blockedByName String?   @map("blocked_by_name") @db.VarChar(100)
  expiresAt     DateTime? @map("expires_at")              // null = permanent
  isActive      Boolean   @default(true) @map("is_active")
  notes         String?   @db.Text
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  @@index([ipAddress], map: "idx_blocked_ip")
  @@index([isActive], map: "idx_blocked_active")
  @@index([threatScore], map: "idx_blocked_threat")
  @@map("blocked_ips")
}

// =====================================================
// Bảng ip_analytics - Phân tích IP theo thời gian
// =====================================================
model IPAnalytics {
  id              Int       @id @default(autoincrement())
  ipAddress       String    @map("ip_address") @db.VarChar(45)
  hourWindow      DateTime  @map("hour_window")           // Truncated to hour
  requestCount    Int       @default(0) @map("request_count")
  uniquePaths     Int       @default(0) @map("unique_paths")
  errorCount      Int       @default(0) @map("error_count")
  avgDuration     Float     @default(0) @map("avg_duration") @db.Float
  userAgents      Int       @default(1) @map("user_agents")  // Number of different UAs
  threatIndicators Json?    @map("threat_indicators")     // Detailed threat signals
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  @@unique([ipAddress, hourWindow], map: "ux_ip_hour")
  @@index([ipAddress], map: "idx_ipanalytics_ip")
  @@index([hourWindow], map: "idx_ipanalytics_hour")
  @@index([requestCount], map: "idx_ipanalytics_count")
  @@map("ip_analytics")
}

// =====================================================
// Bảng seasonal_themes - Cấu hình giao diện theo mùa/sự kiện
// =====================================================
model SeasonalTheme {
  id                Int       @id @default(autoincrement())
  code              String    @unique @db.VarChar(50)       // new_year, tet, valentine, etc.
  name              String    @db.VarChar(100)              // Tên hiển thị
  description       String?   @db.Text                      // Mô tả
  
  // Thời gian áp dụng
  startDate         DateTime  @map("start_date")            // Ngày bắt đầu (MM-DD format stored)
  endDate           DateTime  @map("end_date")              // Ngày kết thúc
  
  // Màu sắc chủ đạo
  primaryColor      String    @map("primary_color") @db.VarChar(20)    // Màu chính (hex)
  secondaryColor    String    @map("secondary_color") @db.VarChar(20)  // Màu phụ (hex)
  accentColor       String?   @map("accent_color") @db.VarChar(20)     // Màu nhấn (hex)
  
  // Hiệu ứng particles (tsparticles config)
  effectType        String?   @map("effect_type") @db.VarChar(50)      // snow, firework, hearts, petals, etc.
  effectConfig      Json?     @map("effect_config")                     // JSON config cho tsparticles
  effectEnabled     Boolean   @default(true) @map("effect_enabled")    // Bật/tắt hiệu ứng
  disableOnMobile   Boolean   @default(true) @map("disable_on_mobile") // Tắt trên mobile
  
  // Trang trí (decorations)
  decorations       Json?     @map("decorations")                       // Array of decoration items
  // Example: [{ type: 'corner', position: 'top-left', imageUrl: '/assets/img/seasonal/...' }]
  
  // Background image
  backgroundImageUrl String?  @map("background_image_url") @db.Text    // Background image URL for the website
  
  // Header banner
  bannerImageUrl    String?   @map("banner_image_url") @db.Text        // Banner image URL
  bannerText        String?   @map("banner_text") @db.VarChar(255)     // Banner text
  bannerLink        String?   @map("banner_link") @db.VarChar(500)     // Banner link
  
  // Trạng thái
  isActive          Boolean   @default(false) @map("is_active")        // Đang active (chỉ 1 theme active)
  priority          Int       @default(0)                               // Ưu tiên khi trùng ngày
  status            String    @default("active") @db.VarChar(20)       // active, inactive
  
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  @@index([isActive], map: "idx_seasonal_active")
  @@index([startDate, endDate], map: "idx_seasonal_dates")
  @@index([status], map: "idx_seasonal_status")
  @@map("seasonal_themes")
}

// =====================================================
// Bảng seasonal_theme_settings - Cài đặt chung cho seasonal themes
// =====================================================
model SeasonalThemeSetting {
  id                Int       @id @default(autoincrement())
  key               String    @unique @db.VarChar(100)      // Setting key
  value             String    @db.Text                      // Setting value (JSON or string)
  description       String?   @db.Text                      // Mô tả
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  @@map("seasonal_theme_settings")
}

// =====================================================
// Bảng blog_categories - Danh mục blog
// =====================================================
model BlogCategory {
  id          Int       @id @default(autoincrement())
  code        String    @unique @db.VarChar(100)          // Mã danh mục (unique)
  name        String    @unique @db.VarChar(255)          // Tên danh mục (unique)
  description String?   @db.Text                          // Mô tả
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@index([code], map: "idx_blog_category_code")
  @@index([name], map: "idx_blog_category_name")
  @@map("blog_categories")
}

// =====================================================
// Bảng product_categories - Danh mục sản phẩm
// =====================================================
model ProductCategory {
  id          Int       @id @default(autoincrement())
  code        String    @unique @db.VarChar(100)          // Mã danh mục (unique)
  name        String    @unique @db.VarChar(255)          // Tên danh mục (unique)
  description String?   @db.Text                          // Mô tả
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@index([code], map: "idx_product_category_code")
  @@index([name], map: "idx_product_category_name")
  @@map("product_categories")
}
